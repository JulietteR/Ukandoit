<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0" name="viewport">
        <title>{% block title %}Ukando'it{% endblock %}</title>
        {% block stylesheets %}{% endblock %}
        <link rel="icon" type="image/x-icon" href="{{ asset('favicon.ico') }}" />
        {% stylesheets  filter='cssrewrite'
        'bundles/AppBundle/materialize/css/materialize.min.css'
        'bundles/AppBundle/css/*'
        %}
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link rel="stylesheet" href="{{ asset_url }}" type="text/css" />
    {% endstylesheets %}
</head>
<body>
    {% include 'include/_header.html.twig' %}
    {% include 'include/_rond.html.twig' %}
    {% block body %}{% endblock %}
    {% include 'include/_footer.html.twig' %}
        {% javascripts
        'bundles/AppBundle/js/*'
        'bundles/AppBundle/materialize/js/materialize.js'
        %}
        <script src='https://www.google.com/recaptcha/api.js'></script>
        <script src="{{ asset_url }}"></script>
        {% endjavascripts %}
    {% block javascripts %}

    {% endblock %}
{% for message in app.session.flashBag.get('message') %}
    <div data-id="{{ message }}" class="flashbag_message"> </div>
      <script type="text/javascript">
        $( document ).ready(function() {
            var id = $('.flashbag_message').data('id');
            toastr.success(id);
        });
    </script>
{% endfor %}

{% if app.request.attributes.get('_route') == "challenges" %}

<!-- AJAX SCROLL INFINI -->

<script type="text/javascript">
$(document).ready(function(){ // Quand le document est complètement chargé

    var load = false; // aucun chargement de card n'est en cours

    /* la fonction offset permet de récupérer la valeur X et Y d'un élément
    dans une page. Ici on récupère la position du dernier div qui
    a pour classe : ".card" */
    var offset = $('.card:last').offset();

    $(window).scroll(function(){ // On surveille l'évènement scroll

        /* Si l'élément offset est en bas de scroll, si aucun chargement
        n'est en cours, si le nombre de card affiché est supérieur
        à 5 et si tout les commentaires ne sont pas affichés, alors on
        lance la fonction. */
        if((offset.top-$(window).height() <= $(window).scrollTop())
        && load==false && ($('.card').size()>=5) &&
        ($('.card').size()!={{ nbChallenges }})){

            // la valeur passe à vrai, on va charger
            load = true;

            //On récupère l'id du dernier card affiché
            var last_id = $('.card:last').attr('id');

            //On affiche un loader
            $('.loadmore').show();

            var DATA = 'last=' + last_id;

            //On lance la fonction ajax
            $.ajax({
                url: "{{ path('defisAjax')}}",
                type: 'get',
                data: DATA,

                //Succès de la requête
                success: function(data) {

                    //On masque le loader
                    $('.loadmore').fadeOut(500);
                    /* On affiche le résultat après
                    le dernier card */
                    $('.defi:last').after(data);
                    /* On actualise la valeur offset
                    du dernier card */
                    offset = $('.card:last').offset();
                    //On remet la valeur à faux car c'est fini
                    load = false;
                }
            });
        }
    });
});

</script>

{% elseif app.request.attributes.get('_route') == "add_defis" %}

<!-- AJAX CHARGEMENT ADD DEFIS  -->

<script type="text/javascript">

$(".modal-trigger-ajax").click(function(){

    var DATA = "montre="+$("#select_montre").val();

    if($("#select_montre").val() != null){

         $.ajax({
            url: "{{ path('addDefisAjax')}}",
            type: 'get',
            data: DATA,

            //Succès de la requête
            success: function(data) {
                $('.modal-content').html(data);
                $('#getDataChallenge').openModal();
            }
        });

    }
    else{
        alert("Veuillez choisir une montre !");
    }
});

</script>

{% endif %}
</body>
</html>